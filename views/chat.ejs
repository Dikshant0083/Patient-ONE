<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212; /* dark bg */
    margin: 0;
    padding: 0;
  }

  #chat-container {
    max-width: 800px;
    margin: 20px auto;
    border: 1px solid #222;
    border-radius: 10px;
    background: #1e1e1e;
    display: flex;
    flex-direction: column;
    height: 90vh;
    box-shadow: 0 2px 10px rgba(0,0,0,0.6);
    overflow: hidden;
  }

  /* Messages area */
  #messages {
    flex: 1;
    list-style: none;
    margin: 0;
    padding: 20px;
    overflow-y: auto;
    background: #0d0d0d; /* very dark bg */
  }

  #messages li {
    margin-bottom: 15px;
    display: inline-block;
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.4;
    position: relative;
    word-wrap: break-word;
    color: #fff;
  }

  /* Sent (right) */
  .msg-sent {
    background: #056162;
    align-self: flex-end;
    float: right;
    clear: both;
    border-bottom-right-radius: 0;
  }

  /* Received (left) */
  .msg-received {
    background: #262d31;
    align-self: flex-start;
    float: left;
    clear: both;
    border-bottom-left-radius: 0;
  }

  .msg-sender {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 4px;
    color: #25d366; /* WhatsApp green */
  }

  .msg-time {
    font-size: 11px;
    color: #bbb;
    text-align: right;
    margin-top: 4px;
    display: block;
  }

  /* Input area */
  #chat-input-area {
    display: flex;
    padding: 10px;
    border-top: 1px solid #333;
    background: #1e1e1e;
  }

  #msg-input {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: none;
    background: #2a2f32;
    color: #fff;
    font-size: 14px;
    outline: none;
  }

  #msg-input::placeholder {
    color: #aaa;
  }

  #send-btn {
    margin-left: 10px;
    background: #25d366; /* WhatsApp green */
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
  }

  #send-btn:hover {
    background: #20b857;
  }
</style>

<div id="chat-container">
  <ul id="messages">
    <% messages.forEach(msg => { %>
      <li class="<%= msg.from.equals(user._id) ? 'msg-sent' : 'msg-received' %>">
        <div class="msg-sender">
          <%= msg.from.equals(user._id) ? user.name || "You" : chatWith.name || "Unknown" %>
        </div>
        <div class="msg-text"><%= msg.text %></div>
        <span class="msg-time"><%= new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></span>
      </li>
    <% }) %>
  </ul>

  <div id="chat-input-area">
    <input id="msg-input" type="text" placeholder="Type a message..." />
    <button id="send-btn">Send</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const userId = "<%= user._id %>";
  const userName = "<%= user.name || user.email %>";
  const toId = "<%= chatWith._id %>";
  const toName = "<%= chatWith.name || chatWith.email %>";
  const roomId = "<%= roomId %>";

  const socket = io();
  socket.emit('join_room', { roomId });

  document.getElementById('send-btn').addEventListener('click', sendMessage);
  document.getElementById('msg-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  function sendMessage() {
    const message = document.getElementById('msg-input').value.trim();
    if (!message) return;

    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    socket.emit('send_message', { from: userId, to: toId, message, roomId });
    document.getElementById('msg-input').value = '';

    appendMessage(userName, message, true, timestamp);
  }

  socket.on('receive_message', ({ from, message, createdAt }) => {
    if (from === userId) return;
    const timestamp = new Date(createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    appendMessage(toName, message, false, timestamp);
  });

  function appendMessage(sender, message, isSent, time) {
    const li = document.createElement('li');
    li.classList.add(isSent ? 'msg-sent' : 'msg-received');
    li.innerHTML = `
      <div class="msg-sender">${sender}</div>
      <div class="msg-text">${message}</div>
      <span class="msg-time">${time}</span>
    `;
    document.getElementById('messages').appendChild(li);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  }

  socket.on('new_message_notification', ({ from, message }) => {
    if (Notification.permission === "granted") {
      new Notification("New Message", { body: message });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") new Notification("New Message", { body: message });
      });
    }
  });
</script>
