<!-- ===================================================================
FILE: views/patient/dashboard.ejs (UPDATED WITH GRANT/REVOKE LOGIC)
=================================================================== -->
<!DOCTYPE html>
<html>
<head>
    <title><%= title %></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <%
      // Safety check to ensure accessList is defined
      if (typeof accessList === 'undefined') {
        accessList = [];
      }
    %>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2><%= title %></h2>
                
                <!-- Flash Messages -->
                <% if (messages.error && messages.error.length > 0) { %>
                    <% messages.error.forEach(error => { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    <% }); %>
                <% } %>

                <% if (messages.success && messages.success.length > 0) { %>
                    <% messages.success.forEach(success => { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <%= success %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    <% }); %>
                <% } %>

                <!-- Upload Medical Record Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Upload Medical Record</h5>
                    </div>
                    <div class="card-body">
                        <form action="/patient/upload" method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="file" class="form-label">Select File</label>
                                <input type="file" class="form-control" id="file" name="file" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload Record</button>
                        </form>
                    </div>
                </div>

                <!-- My Medical Records Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>My Medical Records</h5>
                        <!-- <a href="/public/uploads" class="btn btn-sm btn-outline-primary">View All Records</a> -->
                         <a href="/records/patient/<%= user._id %>" 
   class="btn btn-sm btn-outline-primary">
   View All Records
</a>
                    </div>
                    <div class="card-body">
                        <% if (records && records.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Description</th>
                                            <th>Upload Date</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% records.slice(0, 5).forEach(record => { %>
                                        <tr>
                                            <td><%= record.title %></td>
                                            <td><%= record.description || 'No description' %></td>
                                            <td><%= record.createdAt ? record.createdAt.toDateString() : 'Date not available' %></td>
                                            <td>
                                                <a href="<%= record.fileUrl %>" class="btn btn-sm btn-primary" target="_blank">
                                                    View File
                                                </a>
                                            </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <% if (records.length > 5) { %>
                                <p class="text-muted">Showing 5 of <%= records.length %> records. <a href="/patient/upload">View all records</a></p>
                            <% } %>
                        <% } else { %>
                            <div class="alert alert-info">
                                You haven't uploaded any medical records yet.
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Grant/Revoke Access to Doctors Section -->
                <div class="card">
                    <div class="card-header">
                        <h5>Grant/Revoke Access to Doctors</h5>
                    </div>
                    <div class="card-body">
                        <% if (doctors && doctors.length > 0) { %>
                            <div class="row">
                                <% doctors.forEach(doctor => { %>
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <%= doctor.name || 'Dr. ' + doctor.email %>
                                                </h6>
                                                <p class="card-text text-muted">
                                                    <%= doctor.email %>
                                                </p>
                                                
                                                <%
                                                  // Find the access control record for this doctor
                                                  const access = accessList.find(a => 
                                                    a.doctorId && a.doctorId._id && 
                                                    a.doctorId._id.toString() === doctor._id.toString()
                                                  );
                                                %>
                                                
                                                <% if (access && access.status === 'granted') { %>
                                                    <!-- Doctor has granted access - show REVOKE button -->
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge bg-success">Access Granted</span>
                                                        <a href="/patient/access/<%= doctor._id %>/revoke" 
                                                           class="btn btn-sm btn-danger"
                                                           onclick="return confirm('Are you sure you want to revoke access for this doctor?')">
                                                            Revoke Access
                                                        </a>
                                                        <a href="/chat/patient/<%= doctor._id %>" class="btn btn-sm btn-info mt-2">
  Chat with Doctor
</a>

                                                    </div>
                                                    <small class="text-muted d-block mt-1">
                                                        Granted on: <%= access.grantedAt ? access.grantedAt.toDateString() : 'Unknown' %>
                                                    </small>
                                                <% } else if (access && access.status === 'pending') { %>
                                                    <!-- Doctor has pending request - show GRANT button -->
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge bg-warning">Request Pending</span>
                                                        <a href="/patient/access/<%= doctor._id %>/grant" 
                                                           class="btn btn-sm btn-success">
                                                            Grant Access
                                                        </a>
                                                    </div>
                                                    <small class="text-muted d-block mt-1">
                                                        Requested on: <%= access.createdAt ? access.createdAt.toDateString() : 'Unknown' %>
                                                    </small>
                                                <% } else if (access && access.status === 'revoked') { %>
                                                    <!-- Doctor had access but it was revoked - show GRANT button -->
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge bg-secondary">Access Revoked</span>
                                                        <a href="/patient/access/<%= doctor._id %>/grant" 
                                                           class="btn btn-sm btn-success">
                                                            Grant Access
                                                        </a>
                                                    </div>
                                                <% } else { %>
                                                    <!-- No access record exists - show GRANT button -->
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="badge bg-secondary">No Access</span>
                                                        <a href="/patient/access/<%= doctor._id %>/grant" 
                                                           class="btn btn-sm btn-success">
                                                            Grant Access
                                                        </a>

                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="alert alert-info">
                                No doctors are registered in the system yet.
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Access Requests Summary (Optional) -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Access Summary</h5>
                    </div>
                    <div class="card-body">
                        <%
                          const grantedCount = accessList.filter(a => a.status === 'granted').length;
                          const pendingCount = accessList.filter(a => a.status === 'pending').length;
                          const revokedCount = accessList.filter(a => a.status === 'revoked').length;
                        %>
                        <div class="row text-center">
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h3><%= grantedCount %></h3>
                                        <p>Granted Access</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <h3><%= pendingCount %></h3>
                                        <p>Pending Requests</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body">
                                        <h3><%= revokedCount %></h3>
                                        <p>Revoked Access</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="mt-4">
                    <a href="/profile" class="btn btn-secondary">My Profile</a>
                    <a href="/auth/logout" class="btn btn-outline-secondary">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Optional: Auto-hide alerts after 5 seconds -->
    <script>
        setTimeout(function() {
            var alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                var bootstrapAlert = new bootstrap.Alert(alert);
                bootstrapAlert.close();
            });
        }, 5000);
    </script>
</body>
</html>